<div class="container-fluid py-4">
  <div class="card shadow border-0">
    <!-- Header -->
    <div class="card-header bg-gradient-primary border-0 py-3">
      <div class="row align-items-center">
        <div class="col-6">
          <div class="d-flex align-items-center">
            <i class="ni ni-single-copy-04 text-white me-3 fs-6" style="font-size: 1.5rem; margin-right: 1.1rem;"></i>
            <h3 class="mb-0 text-white fw-bold">{{ 'reportList.header.title' | translate }}</h3>
          </div>
        </div>
        <div class="col-2"> 
        </div>
        <div class="col-4">
          <div class="input-group input-group-merge input-group-alternative bg-white rounded">
            <div class="input-group-prepend">
              <span class="input-group-text"><i class="fas fa-search"></i></span>
            </div>
            <input 
              type="text" 
              class="form-control ps-2" 
              [placeholder]="'reportList.header.searchPlaceholder' | translate"
              [(ngModel)]="searchTerm"
              (input)="applyFilter()">
          </div>
        </div>
      </div>
    </div>

   
    <div class="card-body pt-4 pb-3 px-4">
      <div class="d-flex flex-wrap align-items-end gap-5 mb-2">
        <!-- Statut Filter -->
        <div class="form-group mb-2" style="min-width: 180px; margin-right: 20px;">          <label class="form-control-label text-muted small mb-2">{{ 'reportList.filters.status.label' | translate }}</label>
          <select 
            class="form-control form-control-sm" 
            [(ngModel)]="filterStatus" 
            (change)="applyFilter()">
            <option value="">{{ 'reportList.filters.status.all' | translate }}</option>
            <option value="VALIDATED">{{ 'reportList.filters.status.validated' | translate }}</option>
            <option value="PENDING">{{ 'reportList.filters.status.pending' | translate }}</option>
            <option value="REJECTED">{{ 'reportList.filters.status.rejected' | translate }}</option>
          </select>
        </div>

        <!-- Contributeur Filter -->
        <div class="form-group mb-2" style="min-width: 200px; margin-right: 20px;">
          <label class="form-control-label text-muted small mb-2">{{ 'reportList.filters.contributor.label' | translate }}</label>
          <input 
            type="text" 
            class="form-control form-control-sm" 
            [placeholder]="'reportList.filters.contributor.placeholder' | translate"
            [(ngModel)]="filterContributor" 
            (input)="applyFilter()">
        </div>

        <!-- Date Filter -->
        <div class="form-group mb-2" style="min-width: 180px; margin-right: 20px;">          <label class="form-control-label text-muted small mb-2">{{ 'reportList.filters.date.label' | translate }}</label>
          <input 
            type="date" 
            class="form-control form-control-sm" 
            [(ngModel)]="filterDate" 
            (change)="applyFilter()">
        </div>

        <!-- Reset Button with improved vertical alignment -->
        <div class="form-group mb-2" style="align-self: flex-end;">
          <button 
            class="btn btn-sm btn-outline-primary" 
            (click)="resetFilters()">
            {{ 'reportList.filters.reset' | translate }}
          </button>
        </div>
      </div>
    </div>

    <!-- Table -->
    <div class="table-responsive">
      <table class="table align-items-center mb-0">        <thead class="thead-light">
          <tr>
            <th class="ps-4">{{ 'reportList.table.headers.id' | translate }}</th>
            <th scope="col" class="text-uppercase text-muted text-xs font-weight-bold ps-4">{{ 'reportList.table.headers.contributor' | translate }}</th>
            <th scope="col" class="text-uppercase text-muted text-xs font-weight-bold">{{ 'reportList.table.headers.companyName' | translate }}</th>
            <th scope="col" class="text-uppercase text-muted text-xs font-weight-bold">{{ 'reportList.table.headers.creationDate' | translate }}</th>
            <th scope="col" class="text-uppercase text-muted text-xs font-weight-bold">{{ 'reportList.table.headers.status' | translate }}</th>
            <th scope="col" class="text-uppercase text-muted text-xs font-weight-bold text-center">{{ 'reportList.table.headers.actions' | translate }}</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let fs of getPaginatedData(); index as i" class="border-bottom">
            <td class="ps-4 py-3">
              <span class="mb-0 text-sm font-weight-bold text-darker">{{ fs.id }}</span>
            </td>
            <td class="ps-4 py-3">
              <span class="mb-0 text-sm font-weight-bold text-darker">{{ fs.contributorName || '-' }}</span>
            </td>
            <td class="py-3">
              <span class="mb-0 text-sm font-weight-bold">{{ getCompanyName(fs.formData) }}</span>
            </td>
            <td class="py-3">
              <div class="d-flex align-items-center">
                <span class="text-primary me-3">
                  <i class="ni ni-calendar-grid-58 " style="margin-right: 8px;"></i>
                </span>
                <span class="text-sm ">{{ fs.createdAt | date: 'dd/MM/yyyy HH:mm' }}</span>
              </div>
            </td>
            <td class="py-3">
              <div class="d-flex align-items-center">              <span 
                  class="badge text-xs px-3 py-2 rounded-pill" 
                  [ngClass]="{
                    'bg-soft-success text-success': fs.status === 'VALIDATED',
                    'bg-soft-warning text-warning': fs.status === 'PENDING',
                    'bg-soft-danger text-danger': fs.status === 'REJECTED'
                  }">
                  {{ 'reportList.table.status.' + fs.status.toLowerCase() | translate }}
                </span>
              </div>
            </td>

            <td class="text-center py-3">
              <div class="d-flex justify-content-center gap-2">                
                <!-- USER buttons -->
                <button *ngIf="fs.status === 'VALIDATED' && (currentUserRole === 'USER' || currentUserRole === 'EXPERT_TECHNIQUE')" 
                        class="btn btn-sm btn-primary mb-0"
                        (click)="openPreviewModal(fs.report)">
                  <i class="fas fa-eye me-1"></i> {{ 'reportList.table.actions.preview' | translate }}
                </button>

                <!-- User opens chat modal for rejected statements -->
                <button *ngIf="fs.status === 'REJECTED' && (currentUserRole === 'USER' || currentUserRole === 'EXPERT_TECHNIQUE')" 
                        class="btn btn-sm btn-warning mb-0"
                        (click)="openChatModal(fs)">
                  <i class="fas fa-comments me-1"></i> {{ 'reportList.table.actions.viewDiscussion' | translate }}
                </button>

                <!-- ADMIN buttons -->
                <button *ngIf="currentUserRole === 'ADMIN'" 
                        class="btn btn-sm btn-outline-primary mb-0"
                        (click)="openPreviewModal(fs.report)">
                  <i class="fas fa-eye me-1"></i> {{ 'reportList.table.actions.preview' | translate }}
                </button>

                <!-- Admin validate/reject buttons -->
                <div *ngIf="fs.status === 'PENDING' && currentUserRole === 'ADMIN'" class="btn-group">
                  <button class="btn btn-sm btn-success mb-0" 
                        (click)="validateFinancialStatement(fs)">
                    <i class="fas fa-check me-1"></i> {{ 'reportList.table.actions.validate' | translate }}
                  </button>
                  <button class="btn btn-sm btn-danger mb-0" 
                        (click)="openChatModal(fs, true)">
                    <i class="fas fa-times me-1"></i> {{ 'reportList.table.actions.reject' | translate }}
                  </button>
                </div>

                <!-- ADMIN: Rejected statement actions -->
                <div *ngIf="fs.status === 'REJECTED' && currentUserRole === 'ADMIN'" class="d-flex gap-2">
                  <!-- View Discussion -->
                  <button class="btn btn-sm btn-info mb-0" 
                          (click)="openChatModal(fs)">
                    <i class="fas fa-comments me-1"></i> {{ 'reportList.table.actions.viewDiscussion' | translate }}
                  </button>

                  <!-- Validate Button -->
                  <button class="btn btn-sm btn-success mb-0"
                          (click)="validateFinancialStatement(fs)">
                    <i class="fas fa-check me-1"></i> {{ 'reportList.table.actions.validate' | translate }}
                  </button>
                </div>
              </div>
            </td>
          </tr>          
          <tr *ngIf="filteredStatements.length === 0">
            <td colspan="6" class="text-center py-5">
              <div class="py-4">
                <div class="avatar avatar-lg rounded-circle bg-secondary mx-auto mb-3">
                  <i class="ni ni-folder-17 text-primary"></i>
                </div>
                <h5 class="text-dark mb-1">{{ 'reportList.emptyState.title' | translate }}</h5>
                <p class="text-sm text-muted mb-0" *ngIf="searchTerm">
                  {{ 'reportList.emptyState.searchMessage' | translate: { searchTerm: searchTerm } }}
                </p>
                <p class="text-sm text-muted mb-0" *ngIf="!searchTerm">
                  {{ 'reportList.emptyState.defaultMessage' | translate }}
                </p>
              </div>
            </td>
          </tr>
        </tbody>
      </table>
    </div>    

    <!-- Pagination -->
    <div class="card-footer d-flex justify-content-between align-items-center py-3 px-4 bg-white">
      <div class="d-flex align-items-center">
        <button 
          [disabled]="page <= 1" 
          class="btn btn-sm" 
          [ngClass]="{
            'btn-outline-secondary text-muted cursor-not-allowed': page <= 1,
            'btn-outline-primary': page > 1
          }"
          (click)="prevPage()"
          [attr.aria-disabled]="page <= 1">
          <i class="fas fa-chevron-left me-1"></i> {{ 'reportList.pagination.previous' | translate }}
        </button>
        <button 
          [disabled]="page >= totalPages()" 
          class="btn btn-sm ms-2" 
          [ngClass]="{
            'btn-outline-secondary text-muted cursor-not-allowed': page >= totalPages(),
            'btn-outline-primary': page < totalPages()
          }"
          (click)="nextPage()"
          [attr.aria-disabled]="page >= totalPages()">
          {{ 'reportList.pagination.next' | translate }} <i class="fas fa-chevron-right ms-1"></i>
        </button>
      </div>
      <span class="text-xs text-muted">
        {{ 'reportList.pagination.page' | translate: { current: page, total: totalPages() || 1 } }}
      </span>
    </div>

    <!-- Modal Preview PDF -->
    <div class="modal fade" id="pdfPreviewModal" tabindex="-1" aria-labelledby="pdfPreviewLabel" aria-hidden="true">
      <div class="modal-dialog modal-xl modal-dialog-centered modal-dialog-scrollable">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="pdfPreviewLabel">{{ 'reportList.modal.preview.title' | translate }}</h5>
            
            <!-- Close button without background or border -->
            <button type="button"
                    (click)="closeModal()"
                    [attr.aria-label]="'reportList.modal.preview.close' | translate"
                    style="background: none; border: none; font-size: 1.5rem; line-height: 1; color: #000; cursor: pointer;">
              &times;
            </button>
          </div>
          <div class="modal-body" style="height: 80vh;">
            <ng-container *ngIf="pdfUrl">
              <iframe [src]="pdfUrl" width="100%" height="100%" style="border: none;"></iframe>
            </ng-container>
            <ng-container *ngIf="!pdfUrl">
              <p class="text-center text-muted">{{ 'reportList.modal.preview.loading' | translate }}</p>
            </ng-container>
          </div>
        </div>
      </div>
    </div>

    <!-- Chat Modal -->
    <div class="modal fade" id="chatModal" tabindex="-1" aria-labelledby="chatModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header bg-gradient-primary text-white">
            <h5 class="modal-title text-white" id="chatModalLabel">
              <i class="fas fa-comments me-2"></i>
              {{ 'reportList.modal.chat.title' | translate }} - {{ 'reportList.modal.chat.statementId' | translate }}: {{ selectedFinancialStatement?.id }}
            </h5>
            <button type="button"
                    (click)="closeChatModal()"
                    [attr.aria-label]="'reportList.modal.chat.close' | translate"
                    style="background: none; border: none; font-size: 1.5rem; line-height: 1; color: #fff; cursor: pointer;">
              &times;
            </button>
          </div>
          
          <div class="modal-body p-0">
            <!-- Chat Messages Container -->
            <div class="chat-container" style="height: 400px; overflow-y: auto; padding: 1rem;">
              <div *ngIf="chatMessages?.length === 0" class="text-center text-muted py-4">
                <i class="fas fa-comment-slash fa-2x mb-3"></i>
                <p>{{ 'reportList.modal.chat.noMessages' | translate }}</p>
              </div>
              
              <div *ngFor="let message of chatMessages" class="message-item mb-3">
                <div class="d-flex" [ngClass]="{'justify-content-end': message.sender?.role === currentUserRole}">
                  <div class="message-bubble px-3 py-2 rounded-3 shadow-sm"
                        [ngClass]="{
                          'bg-primary text-white': message.sender?.role === currentUserRole,
                          'bg-light border': message.sender?.role !== currentUserRole
                        }"
                       style="max-width: 70%;">
                    
                    <!-- Message Header -->
                    <div class="message-header mb-1">
                      <small class="fw-bold" 
                             [ngClass]="{
                               'text-white-50': message.senderRole === currentUserRole,
                               'text-muted': message.senderRole !== currentUserRole
                             }">
                        <i class="fas" 
                           [ngClass]="{
                             'fa-user-shield': message.senderRole === 'ADMIN',
                             'fa-user': message.senderRole !== 'ADMIN'
                           }"></i>
                        {{ message.senderName }} ({{ message.senderRole }})
                      </small>
                      <small class="ms-2" 
                             [ngClass]="{
                               'text-white-50': message.senderRole === currentUserRole,
                               'text-muted': message.senderRole !== currentUserRole
                             }">
                        {{ message.timestamp | date: 'dd/MM/yyyy HH:mm' }}
                      </small>
                    </div>
                    
                    <!-- Message Content -->
                    <div class="message-content">
                      {{ message.content }}
                    </div>
                  </div>
                </div>
              </div>
            </div>
            
            <!-- Message Input Area -->
            <div class="border-top p-3 bg-light">
              <div class="input-group">
                <textarea 
                  class="form-control" 
                  [(ngModel)]="newMessage"
                  [placeholder]="'reportList.modal.chat.messagePlaceholder' | translate"
                  rows="2"
                  (keydown.enter)="handleEnterKey($any($event))"
                  style="resize: none;">
                </textarea>
                <button class="btn btn-primary" 
                        (click)="sendMessage()"
                        [disabled]="!newMessage?.trim()">
                  <i class="fas fa-paper-plane"></i>
                </button>
              </div>
              <small class="text-muted mt-1 d-block">
                {{ 'reportList.modal.chat.sendHint' | translate }}
              </small>
            </div>
          </div>
          
          <!-- Modal Footer for Rejection (Admin Only) -->
          <div *ngIf="isRejectionMode && currentUserRole === 'ADMIN'" class="modal-footer bg-danger-soft">
            <div class="w-100">
              <div class="alert alert-warning mb-3">
                <i class="fas fa-exclamation-triangle me-2"></i>
                {{ 'reportList.modal.chat.rejectionWarning' | translate }}
              </div>
              <div class="d-flex justify-content-end gap-2">
                <button type="button" class="btn btn-secondary" (click)="closeChatModal()">
                  {{ 'reportList.modal.chat.cancel' | translate }}
                </button>
                <button type="button" 
                        class="btn btn-danger" 
                        (click)="confirmRejection()"
                        [disabled]="chatMessages?.length === 0">
                  <i class="fas fa-times me-1"></i>
                  {{ 'reportList.modal.chat.confirmReject' | translate }}
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  </div>
</div>